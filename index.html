<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aarush’s Daily Market Brief</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --chip:#eaeef2; --link:#2563eb;
      --sidebar-w: 320px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--fg); background:#fafbfc; }
    .wrap { display:flex; min-height:100vh; }
    header { position:sticky; top:0; background:#111827; color:#fff; padding:16px 20px; z-index:5; }
    header .date { color:#c9d1d9; font-size:12px; margin-top:4px; }
    main { flex:1; max-width:1000px; margin:0 auto; padding:20px; }
    .card { background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    .section { padding:18px 20px; border-top:1px solid var(--line); }
    .section:first-child { border-top:none; }
    h1 { font-size:20px; margin:0; }
    h2 { font-size:18px; margin:0; }
    p { margin:0; }
    .content { padding:18px 20px; }
    .muted { color:var(--muted); font-size:12px; }
    .chips span { display:inline-block; padding:3px 8px; border:1px solid #d0d7de; border-radius:999px; font-size:12px; margin-right:6px; }
    .insight { padding:12px 0; border-bottom:1px solid var(--line); }
    .insight:last-child { border-bottom:none; }
    .ticker { display:inline-block; background:#2563eb; color:#fff; border-radius:6px; padding:2px 6px; margin-right:8px; font-weight:600; }
    .watch { background:#eaeef2; color:#111827; }
    a { color:var(--link); text-decoration:none; }
    .sources li { margin:6px 0; }
    /* Sidebar */
    .layout { display:grid; grid-template-columns: 1fr var(--sidebar-w); gap:20px; align-items:start; }
    .sidebar { position:sticky; top:0; max-height:100vh; overflow-y:auto; background:#fff; border:1px solid var(--line); border-radius:12px; }
    .sidebar h3 { font-size:14px; margin:0; padding:14px 14px; border-bottom:1px solid var(--line); }
    .list { list-style:none; padding:0; margin:0; }
    .list li { border-bottom:1px solid var(--line); }
    .list a { display:block; padding:12px 14px; color:#111827; font-size:14px; }
    .list a small { display:block; color:#6b7280; font-size:12px; }
    .list a.active { background:#f6f8fa; }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position:relative; max-height:none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Aarush’s Daily Market Brief</h1>
    <div class="date" id="topDate"></div>
  </header>

  <main>
    <div class="layout">
      <!-- Main content -->
      <div>
        <div class="card" id="briefCard" hidden>
          <div class="section">
            <h2 id="briefTitle">Daily Brief</h2>
            <div class="muted" id="briefDate"></div>
          </div>

          <div class="section">
            <h2>Summary</h2>
            <div class="content" id="summary"></div>
          </div>

          <div class="section">
            <h2>Insights</h2>
            <div class="content" id="insights"></div>
          </div>

          <div class="section">
            <h2>Watchlist</h2>
            <div class="content" id="watchlist"></div>
          </div>

          <div class="section">
            <h2>Sources</h2>
            <div class="content">
              <ul id="sources" class="sources"></ul>
            </div>
          </div>

          <div class="section muted">
            <em>Note: This brief is synthesized from social posts. It is not investment advice.</em>
          </div>
        </div>
      </div>

      <!-- Sidebar archive -->
      <aside class="sidebar">
        <h3>Archive</h3>
        <ul class="list" id="archiveList"></ul>
      </aside>
    </div>
  </main>

  <script>
    const fmtDate = (dStr) => {
      const d = new Date(dStr);
      if (isNaN(d)) return dStr;
      return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
    };

    const state = { briefs: [], currentIndex: 0 };

    const renderArchive = () => {
      const ul = document.getElementById('archiveList');
      ul.innerHTML = '';
      state.briefs.forEach((b, i) => {
        const a = document.createElement('a');
        a.href = `#${b.id}`;
        a.innerHTML = `${b.subject || 'Daily Brief'}<small>${fmtDate(b.date)}</small>`;
        if (i === state.currentIndex) a.classList.add('active');
        const li = document.createElement('li'); li.appendChild(a);
        ul.appendChild(li);
      });
    };

    const renderBrief = (idx) => {
      const b = state.briefs[idx];
      if (!b) return;

      document.getElementById('topDate').textContent = fmtDate(b.date);
      document.getElementById('briefDate').textContent = fmtDate(b.date);
      document.getElementById('briefTitle').textContent = b.subject || 'Daily Brief';

      // Prefer structured JSON if present; otherwise use HTML/text
      const summaryEl = document.getElementById('summary');
      const insightsEl = document.getElementById('insights');
      const watchlistEl = document.getElementById('watchlist');
      const sourcesEl = document.getElementById('sources');

      summaryEl.innerHTML = '';
      insightsEl.innerHTML = '';
      watchlistEl.innerHTML = '';
      sourcesEl.innerHTML = '';

      if (b.json) {
        const j = b.json;
        summaryEl.textContent = j.summary || '';

        if (Array.isArray(j.insights)) {
          j.insights.forEach(it => {
            const div = document.createElement('div'); div.className = 'insight';
            div.innerHTML = `
              <div><span class="ticker">${(it.ticker||'').toUpperCase()}</span>
              <span>${it.bullet || ''}</span></div>
              <div class="chips" style="margin-top:6px;">
                ${it.horizon ? `<span>Horizon: ${it.horizon}</span>` : ''}
                ${it.conviction ? `<span>Conviction: ${it.conviction}</span>` : ''}
              </div>
              ${it.recommendation ? `<div style="margin-top:8px;font-size:13px;"><em>${it.recommendation}</em></div>` : ''}
            `;
            insightsEl.appendChild(div);
          });
        }

        if (Array.isArray(j.watchlist)) {
          j.watchlist.forEach(w => {
            const div = document.createElement('div'); div.className = 'insight';
            div.innerHTML = `
              <div><span class="ticker watch">${(w.ticker||'').toUpperCase()}</span>
              <span>${w.why || ''}</span></div>
              <div class="chips" style="margin-top:6px;">
                ${w.horizon ? `<span>Horizon: ${w.horizon}</span>` : ''}
              </div>
              ${w.recommendation ? `<div style="margin-top:8px;font-size:13px;"><em>${w.recommendation}</em></div>` : ''}
            `;
            watchlistEl.appendChild(div);
          });
        }

        if (Array.isArray(j.sources)) {
          j.sources.forEach(s => {
            const li = document.createElement('li');
            const note = s.note ? `${s.note} — ` : '';
            li.innerHTML = `${note}<a href="${s.url}" target="_blank" rel="noopener">${s.url}</a>`;
            sourcesEl.appendChild(li);
          });
        }
      } else if (b.html) {
        // Fall back: show your email HTML
        summaryEl.innerHTML = b.html;
      } else if (b.text) {
        summaryEl.textContent = b.text;
      }

      document.getElementById('briefCard').hidden = false;
    };

    const selectByHash = () => {
      const id = location.hash.replace('#', '');
      const idx = state.briefs.findIndex(b => b.id === id);
      state.currentIndex = idx >= 0 ? idx : 0;
      renderBrief(state.currentIndex);
      renderArchive();
    };

    // Load briefs and render
    fetch('briefs.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(arr => {
        // Expect newest first; if not, sort desc by date
        arr.sort((a,b) => new Date(b.date) - new Date(a.date));
        state.briefs = arr;
        selectByHash();
        window.addEventListener('hashchange', selectByHash);
      })
      .catch(() => {
        document.getElementById('topDate').textContent = 'Could not load briefs.json';
      });
  </script>
</body>
</html>